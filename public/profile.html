<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile | TravelBuddy</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* GLOBAL */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Poppins',sans-serif;background:#f4f9f9;color:#2D3436;overflow-x:hidden;}
a{text-decoration:none;color:inherit;}
ul{list-style:none;}

/* NAVBAR */
.navbar{background:#fff;position:fixed;top:0;width:100%;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.nav-container{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center;height:70px;}
.nav-logo h2{color:#00BFA6;font-size:1.9rem;font-weight:700;}

.nav-menu{display:flex;gap:2rem;align-items:center;}
.nav-menu li a{color:#2D3436;font-weight:500;transition:0.3s;}
.nav-menu li a:hover{color:#00BFA6;}

.menu-toggle{display:none;font-size:1.8rem;color:#00BFA6;cursor:pointer;}

.user-profile-dropdown{position:relative;display:flex;align-items:center;gap:8px;cursor:pointer;}
.user-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #00BFA6;}
.user-name{font-weight:600;color:#00BFA6;display:flex;align-items:center;gap:5px;}

.dropdown-content{
  display:none;position:absolute;right:0;top:55px;background:white;border-radius:10px;
  box-shadow:0 5px 25px rgba(0,0,0,0.15);min-width:180px;overflow:hidden;
}
.dropdown-content a{
  display:block;padding:10px 15px;color:#333;font-weight:500;transition:0.3s;
}
.dropdown-content a:hover{background:linear-gradient(135deg,#00BFA6,#FDCB6E);color:white;}

@media(max-width:900px){
  .menu-toggle{display:block;}
  .nav-menu{
    position:fixed;top:70px;left:-100%;width:100%;background:#fff;
    padding:2rem;flex-direction:column;transition:0.3s;
  }
  .nav-menu.active{left:0;}
}

/* HERO */
.page-hero{
  background:linear-gradient(135deg,#00BFA6,#FDCB6E);
  padding:150px 20px 80px;text-align:center;color:white;
  border-bottom-left-radius:50px;border-bottom-right-radius:50px;
}
.page-hero h1{font-size:3rem;font-weight:700;margin-bottom:1rem;}

/* CONTENT */
.page-content{max-width:1000px;margin:0 auto;padding:80px 20px;}
.profile-card{
  background:white;padding:40px;border-radius:20px;
  box-shadow:0 8px 25px rgba(0,0,0,0.08);text-align:center;
}
.profile-card img{
  width:160px;height:160px;border-radius:50%;
  object-fit:cover;margin-bottom:20px;border:4px solid #00BFA6;
}
.profile-card h2{color:#00BFA6;font-size:2rem;margin-bottom:10px;}
.profile-card p{margin:6px 0;color:#555;font-weight:500;}
.profile-card hr{margin:25px 0;border:0;border-top:1px solid #eee;}

.btn{
  margin:10px;padding:12px 28px;border:none;border-radius:12px;
  background:linear-gradient(135deg,#00BFA6,#FDCB6E);
  color:white;font-size:1rem;font-weight:600;cursor:pointer;transition:0.3s;
}
.btn:hover{opacity:0.9;transform:translateY(-2px);}

/* SECTIONS */
.section{text-align:left;margin-bottom:40px;}
.section h3{color:#00BFA6;margin-bottom:15px;font-size:1.3rem;}

.stats-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:15px;margin-top:10px;
}
.stat-card{
  background:linear-gradient(135deg,#00BFA6,#FDCB6E);
  color:white;padding:15px;border-radius:15px;text-align:center;
}

.cards-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;margin-top:10px;
}

.card{
  background:white;padding:15px;border-radius:15px;
  box-shadow:0 4px 15px rgba(0,0,0,0.05);
}
.small-muted{font-size:0.85rem;color:#666;}

/* MODAL */
.modal{
  display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);justify-content:center;align-items:center;
}
.modal-content{
  background:#1e1e2f;padding:20px;border-radius:12px;
  width:90%;max-width:400px;color:white;position:relative;
}
.close-btn{
  position:absolute;top:10px;right:15px;font-size:24px;
  cursor:pointer;color:white;
}
.modal-content input{
  width:100%;padding:10px;margin:8px 0;border:none;border-radius:8px;
}
.modal-content button{
  width:100%;padding:10px;margin-top:12px;border:none;border-radius:8px;
  background:#4CAF50;color:white;font-weight:600;cursor:pointer;
}
</style>

</head>

<body>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-logo"><h2>TravelBuddy</h2></div>

    <div class="menu-toggle" id="mobileMenu"><i class="fas fa-bars"></i></div>

    <ul class="nav-menu" id="nav-menu">
      <li><a href="index.html">Home</a></li>
      <li><a href="find-companion.html">Find Companion</a></li>
      <li><a href="explore.html">Plan a Trip</a></li>
      <li><a href="blog.html">Blog</a></li>
      <li id="auth-section"></li>
    </ul>

  </div>
</nav>

<!-- HERO -->
<section class="page-hero">
  <h1>Your Profile</h1>
  <p>View and manage all your travel info in one place</p>
</section>

<!-- CONTENT -->
<section class="page-content">
  <div class="profile-card">

    <img id="profilePhoto">
    <h2 id="profileName">User Name</h2>
    <p id="profileEmail"></p>
    <p id="profileCollege"></p>
    <p id="profileBio"></p>
    <hr>

    <!-- TRAVEL STATS -->
    <div class="section">
      <h3>Travel Stats</h3>
      <div class="stats-grid">
        <div class="stat-card"><h4>Total Trips</h4><p id="totalTrips">0</p></div>
        <div class="stat-card"><h4>Total Distance</h4><p id="totalDistance">0 km</p></div>
        <div class="stat-card"><h4>Average Rating</h4><p id="avgRating">N/A</p></div>
      </div>
    </div>

    <div class="section">
      <h3>Recent Trips</h3>
      <div class="cards-grid" id="recentTrips">
        <div class="card"><p>Loading...</p></div>
      </div>
    </div>

    <div class="section">
      <h3>Requests</h3>
      <div class="cards-grid" id="requestsArea">
        <div class="card"><p>Loading...</p></div>
      </div>
    </div>

    <div class="section">
      <h3>Connections</h3>
      <div class="cards-grid" id="connectionsArea">
        <div class="card"><p>Loading...</p></div>
      </div>
    </div>

    <button class="btn" id="editProfileBtn">Edit Profile ‚úèÔ∏è</button>
    <button class="btn" id="writeBlogBtn">Write Blog üìù</button>
    <button class="btn" id="logoutBtn">Logout</button>

  </div>
</section>

<!-- EDIT MODAL -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-btn" id="closeModal">&times;</span>
    <h2>Edit Profile</h2>

    <form id="editProfileForm">
      <input type="text" id="editFirstName" placeholder="First Name" required>
      <input type="text" id="editLastName" placeholder="Last Name" required>
      <input type="text" id="editCollege" placeholder="College">
      <input type="text" id="editBio" placeholder="Bio">

      <label style="margin-top:10px;">Change Photo:</label>
      <input type="file" id="editPhoto" accept="image/*">

      <button type="submit">Save Changes</button>
    </form>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {

  const socket = io();
  const baseURL = window.location.hostname === "localhost"
    ? "http://localhost:5001"
    : "https://travelbuddy-hluu.onrender.com";

  let user = JSON.parse(localStorage.getItem("user"));
  const defaultImg = "https://cdn-icons-png.flaticon.com/512/1077/1077114.png";

  /* NAV MENU */
  document.getElementById("mobileMenu").onclick = () =>
    document.getElementById("nav-menu").classList.toggle("active");

  /* NAVBAR USER DROPDOWN */
  const authSection = document.getElementById("auth-section");

  if (user) {
    authSection.innerHTML = `
      <div class="user-profile-dropdown" id="userDropdown">
        <img src="${user.img || defaultImg}" class="user-avatar">
        <span class="user-name">${user.firstName || user.email.split('@')[0]}
          <i class="fas fa-caret-down"></i>
        </span>

        <div class="dropdown-content" id="dropdownMenu">
          <a href="profile.html">My Profile</a>
          <a href="trips.html">Trips</a>
          <a href="blogs.html">Blogs</a>
          <a href="#" id="logoutDropdown">Logout</a>
        </div>
      </div>
    `;

    document.querySelector(".user-name").onclick = () => {
      const dd = document.getElementById("dropdownMenu");
      dd.style.display = dd.style.display === "block" ? "none" : "block";
    };

    document.getElementById("logoutDropdown").onclick = () => {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    };
  }

  /* JOIN SOCKET ROOM */
  if (user?.email) socket.emit("join", { email: user.email });

  /* FETCH PROFILE */
  async function fetchProfileData() {
    const res = await fetch(`${baseURL}/api/user-profile?email=${user.email}`);
    const data = await res.json();
    if (data.success) populateProfile(data.user);
  }

  /* POPULATE UI */
  function populateProfile(u) {
    document.getElementById("profileName").innerText = `${u.firstName} ${u.lastName}`;
    document.getElementById("profileEmail").innerText = u.email;
    document.getElementById("profileCollege").innerText = "College: " + (u.college || "N/A");
    document.getElementById("profileBio").innerText = u.bio || "Traveler and explorer!";
    document.getElementById("profilePhoto").src = u.img || defaultImg;

    document.getElementById("totalTrips").innerText = u.trips?.length || 0;
    document.getElementById("totalDistance").innerText = (u.totalDistance || 0) + " km";
    document.getElementById("avgRating").innerText = u.rating || "N/A";

    /* RECENT TRIPS */
    document.getElementById("recentTrips").innerHTML =
      u.trips?.length
        ? u.trips
            .map(t => `<div class="card"><h4>${t.destination}</h4><p>${t.date}</p></div>`)
            .join("")
        : `<div class="card"><p>No trips yet</p></div>`;

    /* REQUESTS */
    const reqArea = document.getElementById("requestsArea");
    reqArea.innerHTML = "";
    (u.requests || []).forEach(r => {
      reqArea.innerHTML += `
        <div class="card">
          <p><strong>${r.fromName}</strong> (${r.fromEmail})</p>
          <p class="small-muted">Status: ${r.status}</p>

          ${
            r.status === "pending"
              ? `<button class="btn acceptBtn" data-from="${r.fromEmail}">Accept</button>
                 <button class="btn rejectBtn" data-from="${r.fromEmail}" style="background:#e74c3c">Reject</button>`
              : ""
          }
        </div>
      `;
    });

    /* CONNECTIONS */
    const conn = document.getElementById("connectionsArea");
    conn.innerHTML = (u.connections || [])
      .map(email => `
        <div class="card">
          <p>${email}</p>
          <a class="view-btn" href="chat.html?to=${email}">Chat</a>
          <a class="view-btn" href="companion-profile.html?email=${email}" style="margin-left:10px;">View</a>
        </div>
      `)
      .join("");
  }

  /* INITIAL LOAD */
  fetchProfileData();

  /* ACCEPT / REJECT */
  document.addEventListener("click", async (e) => {
    if (e.target.matches(".acceptBtn")) {
      const fromEmail = e.target.dataset.from;

      const res = await fetch(`${baseURL}/api/respond-request`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ toEmail: user.email, fromEmail, action: "accept" })
      });

      const out = await res.json();
      if (out.success) {
        alert("Request accepted!");
        fetchProfileData();   // no redirect
      }
    }

    if (e.target.matches(".rejectBtn")) {
      const fromEmail = e.target.dataset.from;

      await fetch(`${baseURL}/api/respond-request`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ toEmail: user.email, fromEmail, action: "reject" })
      });

      alert("Request rejected.");
      fetchProfileData();
    }
  });

  /* SOCKET: update profile silently */
  socket.on("request-accepted", () => fetchProfileData());
});
</script>

</body>
</html>
