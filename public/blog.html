<!-- public/blog.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Community Blogs & Photos | TravelBuddy</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;background:#f7f9f9;color:#223;}
    a{text-decoration:none;color:inherit}

    /* Navbar */
    .navbar{position:fixed;top:0;left:0;right:0;background:#fff;box-shadow:0 4px 18px rgba(0,0,0,0.06);z-index:1000}
    .nav-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:15px 20px}
    .logo{color:#00BFA6;font-weight:700;font-size:1.4rem}

    /* Hero */
    .hero{background:linear-gradient(135deg,#00BFA6,#30DFA6);color:#fff;padding:120px 20px 40px;text-align:center}
    .hero h1{font-size:2.4rem;margin-bottom:6px}
    .hero p{opacity:0.95}

    /* Switch */
    .switch-wrap{display:flex;justify-content:center;gap:10px;margin:20px auto;max-width:1100px;padding:0 20px}
    .seg-btn{border-radius:999px;padding:10px 22px;border:none;background:#eee;font-weight:600;cursor:pointer}
    .seg-btn.active{background:#00BFA6;color:#fff;transform:scale(1.03)}

    /* layout */
    .container{max-width:1100px;margin:18px auto;padding:0 20px 60px;display:block}
    .top-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:10px}
    .write-btn, .upload-btn{background:#00BFA6;color:white;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600}

    /* Blog grid */
    .blog-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px}
    .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 22px rgba(17,17,17,0.06);transition:transform .18s}
    .card:hover{transform:translateY(-6px)}
    .card .thumb{height:200px;width:100%;object-fit:cover;background:#ddd}
    .card .body{padding:14px}
    .card h3{color:#00BFA6;font-size:1.1rem;margin-bottom:6px}
    .meta{font-size:0.85rem;color:#666;margin-bottom:8px}
    .desc{color:#333;font-size:0.95rem;height:64px;overflow:hidden}
    .read-more{display:inline-block;margin-top:10px;color:#00BFA6;font-weight:600}

    /* Photos grid */
    .photo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:10px}
    .photo-card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .photo-card img{width:100%;height:160px;object-fit:cover;display:block}

    /* small */
    .small{font-size:0.9rem;color:#666}

    /* responsive */
    @media(max-width:640px){
      .hero h1{font-size:1.6rem}
      .card .desc{height:80px}
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-inner">
      <div class="logo">TravelBuddy</div>
      <div>
        <a href="index.html" style="margin-right:14px">Home</a>
        <a href="profile.html">Profile</a>
      </div>
    </div>
  </nav>

  <header class="hero">
    <h1>TravelBuddy Community</h1>
    <p>Latest travel blogs and photos from people like you</p>
  </header>

  <div class="switch-wrap">
    <button id="btnBlogs" class="seg-btn active">üìù Blogs</button>
    <button id="btnPhotos" class="seg-btn">üì∏ Photos</button>
  </div>

  <main class="container">
    <div class="top-actions">
      <div>
        <button id="writeBtn" class="write-btn">‚úçÔ∏è Write Blog</button>
      </div>
      <div>
        <input id="photoUpload" type="file" accept="image/*" style="display:none" />
        <button id="uploadBtn" class="upload-btn">üì§ Upload Photo</button>
      </div>
    </div>

    <!-- BLOGS SECTION -->
    <section id="blogsSection">
      <div class="blog-grid" id="blogGrid"></div>
    </section>

    <!-- PHOTOS SECTION (hidden initially) -->
    <section id="photosSection" style="display:none;">
      <div class="photo-grid" id="photoGrid"></div>
    </section>
  </main>

  <footer style="text-align:center;padding:40px 20px;color:#777">
    ¬© 2025 TravelBuddy
  </footer>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const baseURL = window.location.hostname === "localhost"
      ? "http://localhost:5001"
      : "";

    // UI elements
    const btnBlogs = document.getElementById("btnBlogs");
    const btnPhotos = document.getElementById("btnPhotos");
    const blogsSection = document.getElementById("blogsSection");
    const photosSection = document.getElementById("photosSection");
    const blogGrid = document.getElementById("blogGrid");
    const photoGrid = document.getElementById("photoGrid");
    const writeBtn = document.getElementById("writeBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const photoUpload = document.getElementById("photoUpload");

    // Simple auth check from localStorage
    const user = JSON.parse(localStorage.getItem("user") || "null");

    writeBtn.addEventListener("click", ()=> {
      if(!user) return alert("Please log in to write a blog.");
      window.location.href = "write-blog.html";
    });

    uploadBtn.addEventListener("click", ()=> {
      if(!user) return alert("Please log in to upload photos.");
      photoUpload.click();
    });

    photoUpload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const base64 = await toBase64(file);

      const payload = {
        image: base64,
        author: `${user?.firstName || 'Unknown'}`,
        authorEmail: user?.email || null
      };

      try {
        const res = await fetch("/api/add-photo", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success){
          // prepend
          prependPhotoCard(data.photo);
          alert("Photo uploaded to community.");
        } else {
          alert("Upload failed.");
        }
      } catch(err){
        console.error(err);
        alert("Upload error");
      }
      photoUpload.value = "";
    });

    // Switch UI
    btnBlogs.onclick = () => {
      btnBlogs.classList.add("active");
      btnPhotos.classList.remove("active");
      blogsSection.style.display = "";
      photosSection.style.display = "none";
    };
    btnPhotos.onclick = () => {
      btnPhotos.classList.add("active");
      btnBlogs.classList.remove("active");
      blogsSection.style.display = "none";
      photosSection.style.display = "";
    };

    // UTIL: base64
    function toBase64(file){
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.readAsDataURL(file);
        r.onload = () => res(r.result);
        r.onerror = rej;
      });
    }

    // Format date
    function niceDate(iso){
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch(e){ return iso; }
    }

    // RENDER blog card (Rich: image, title, destination, author+date, short description)
    function renderBlogCard(b){
      const img = Array.isArray(b.image) ? (b.image[0] || '') : (b.image || '');
      const destination = b.destination ? `<div class="meta">üìç ${escapeHtml(b.destination)}</div>` : '';
      const authorLine = `<div class="meta">‚úçÔ∏è ${escapeHtml(b.author || 'Anonymous')} ‚Ä¢ ${niceDate(b.createdAt)}</div>`;
      const short = stripHtml(b.content || '').slice(0,180);

      const card = document.createElement("article");
      card.className = "card";
      card.innerHTML = `
        <img class="thumb" src="${img || 'https://cdn-icons-png.flaticon.com/512/564/564619.png'}" alt="thumb" />
        <div class="body">
          <h3>${escapeHtml(b.title || 'Untitled')}</h3>
          ${destination}
          ${authorLine}
          <div class="desc">${escapeHtml(short)}...</div>
          <a class="read-more" href="blog-view.html?id=${b._id || b.id || ''}">Read full</a>
        </div>
      `;
      return card;
    }

    // strip html
    function stripHtml(html){
      const tmp = document.createElement("div");
      tmp.innerHTML = html || '';
      return tmp.textContent || tmp.innerText || '';
    }

    function escapeHtml(s){
      if(!s) return '';
      return s.replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // Prepend helper
    function prependBlogCard(b){
      const card = renderBlogCard(b);
      blogGrid.prepend(card);
    }
    function prependPhotoCard(p){
      const div = document.createElement("div");
      div.className = "photo-card";
      div.innerHTML = `<img src="${p.image}"><div style="padding:8px;font-size:0.85rem;color:#444">üì∏ ${escapeHtml(p.author)}</div>`;
      photoGrid.prepend(div);
    }

    // LOAD blogs & photos from server (with demo fallback for blogs < 10)
    async function loadCommunity(){
      // blogs
      try {
        const res = await fetch("/api/all-blogs");
        const data = await res.json();
        let blogs = [];
        if(data.success && Array.isArray(data.blogs)) blogs = data.blogs;
        // demo fallback if less than 10
        const demo = [
          { title:"Backpacking Europe", content:"Paris, Rome & Amsterdam in one trip.", image:["https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&w=900&q=80"], author:"Demo User", createdAt:new Date().toISOString(), destination:"Europe" },
          { title:"Himalayan Trek", content:"Breathtaking trails & views.", image:["https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=900&q=80"], author:"Demo", createdAt:new Date().toISOString(), destination:"Himalayas" },
          { title:"Beach Escapes", content:"Relax and unwind on the sands.", image:["https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=900&q=80"], author:"Demo", createdAt:new Date().toISOString(), destination:"Goa" }
        ];
        if(blogs.length < 10){
          const need = 10 - blogs.length;
          blogs = [...blogs, ...demo.slice(0, need)];
        }
        // render
        blogGrid.innerHTML = "";
        blogs.slice(0,10).forEach(b => {
          const card = renderBlogCard(b);
          blogGrid.appendChild(card);
        });
      } catch(err){
        console.error("load blogs error", err);
      }

      // photos
      try {
        const res2 = await fetch("/api/all-photos");
        const data2 = await res2.json();
        if(data2.success && Array.isArray(data2.photos)){
          photoGrid.innerHTML = "";
          data2.photos.forEach(p => {
            const div = document.createElement("div");
            div.className = "photo-card";
            div.innerHTML = `<img src="${p.image}"><div style="padding:8px;font-size:0.85rem;color:#444">üì∏ ${escapeHtml(p.author)}</div>`;
            photoGrid.appendChild(div);
          });
        } else {
          photoGrid.innerHTML = "";
        }
      } catch(err){
        console.error("load photos error", err);
      }
    }

    loadCommunity();

    // socket real-time updates
    socket.on("new-blog", (blog) => {
      // prepend directly
      prependBlogCard(blog);
    });

    socket.on("new-photo", (photo) => {
      prependPhotoCard(photo);
    });

    // join socket room for personal events (if user exists)
    if(user?.email) socket.emit("join", { email: user.email });
  </script>
</body>
</html>
