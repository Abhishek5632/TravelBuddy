<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Companion Profile | TravelBuddy</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* GLOBAL */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Poppins',sans-serif;background:#f4f9f9;color:#2D3436;overflow-x:hidden;}
a{text-decoration:none;color:inherit;}
ul{list-style:none;}

/* ----------------------------------------------------
   UNIVERSAL TRAVELBUDDY NAVBAR
-----------------------------------------------------*/
.tb-navbar{
  width:100%;
  position:fixed;
  top:0;
  left:0;
  z-index:10000;
  background:linear-gradient(135deg,#00BFA6,#00D2A6,#00E3A0);
  padding:12px 0;
  box-shadow:0 6px 25px rgba(0,0,0,0.15);
  animation:gradientMove 6s infinite alternate ease-in-out;
}
@keyframes gradientMove{
  0%{background:linear-gradient(135deg,#00BFA6,#00D2A6,#00E3A0);}
  100%{background:linear-gradient(135deg,#00E3A0,#00D2A6,#00BFA6);}
}

.tb-nav-container{
  max-width:1250px;
  margin:auto;
  padding:0 24px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.tb-logo{
  font-size:1.9rem;
  font-weight:700;
  color:white;
}

.tb-links{
  display:flex;
  align-items:center;
  gap:30px;
}

.tb-links a{
  color:white;
  font-weight:500;
  transition:.2s;
}

.tb-links a:hover{
  opacity:.8;
  transform:translateY(-2px);
}

.tb-right{
  display:flex;
  align-items:center;
  gap:14px;
}

.tb-burger{
  font-size:2rem;
  color:white;
  cursor:pointer;
  display:none;
}

.tb-profile{
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  color:white;
  position:relative;
}

.tb-profile img{
  width:42px;
  height:42px;
  border-radius:50%;
  border:2px solid white;
  object-fit:cover;
}

.tb-dropdown{
  position:absolute;
  top:58px;
  right:0;
  background:white;
  width:180px;
  border-radius:12px;
  display:none;
  overflow:hidden;
  box-shadow:0 8px 25px rgba(0,0,0,0.15);
}

.tb-dropdown a{
  display:block;
  padding:12px 15px;
  color:#333;
  font-weight:500;
}

.tb-dropdown a:hover{
  background:linear-gradient(135deg,#00BFA6,#FDCB6E);
  color:white;
}

.tb-mobile-menu{
  display:none;
  flex-direction:column;
  background:white;
  width:100%;
  padding:20px 0;
  text-align:center;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
}

.tb-mobile-menu a{
  padding:12px 0;
  color:#00BFA6;
  font-weight:600;
  border-bottom:1px solid #eee;
}

@media(max-width:900px){
  .tb-links{display:none;}
  .tb-burger{display:block;}
}

/* HERO */
.page-hero{
  background:linear-gradient(135deg,#00BFA6,#FDCB6E);
  padding:160px 20px 80px;
  text-align:center;
  color:white;
  border-bottom-left-radius:50px;
  border-bottom-right-radius:50px;
}
.page-hero h1{font-size:3rem;font-weight:700;margin-bottom:1rem;}

/* CONTENT */
.page-content{max-width:1000px;margin:0 auto;padding:80px 20px;}
.profile-card{
  background:white;padding:40px;border-radius:20px;
  box-shadow:0 8px 25px rgba(0,0,0,0.08);text-align:center;
}
.profile-card img{
  width:160px;height:160px;border-radius:50%;
  object-fit:cover;margin-bottom:20px;border:4px solid #00BFA6;
}
.profile-card h2{color:#00BFA6;font-size:2rem;margin-bottom:10px;}
.profile-card p{margin:6px 0;color:#555;font-weight:500;}
.profile-card hr{margin:25px 0;border:0;border-top:1px solid #eee;}

.btn{
  margin:10px;padding:12px 28px;border:none;border-radius:12px;
  background:linear-gradient(135deg,#00BFA6,#FDCB6E);
  color:white;font-size:1rem;font-weight:600;cursor:pointer;transition:0.3s;
}
.btn:hover{opacity:0.9;transform:translateY(-2px);}

.section{text-align:left;margin-bottom:40px;}
.section h3{color:#00BFA6;margin-bottom:15px;font-size:1.3rem;}

.stats-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:15px;margin-top:10px;
}
.stat-card{
  background:linear-gradient(135deg,#00BFA6,#FDCB6E);
  color:white;padding:15px;border-radius:15px;text-align:center;
}

.card{
  background:white;padding:15px;border-radius:15px;
  box-shadow:0 4px 15px rgba(0,0,0,0.05);
  margin-top:10px;
}

.small-muted{font-size:0.85rem;color:#666;}

</style>
</head>

<body>

<!-- UNIVERSAL NAVBAR -->
<nav class="tb-navbar">
  <div class="tb-nav-container">

    <div class="tb-logo">TravelBuddy</div>

    <div class="tb-links">
      <a href="index.html">Home</a>
      <a href="find-companion.html">Find Companion</a>
      <a href="explore.html">Plan a Trip</a>
      <a href="blog.html">Community</a>
    </div>

    <div class="tb-right">
      <div class="tb-burger" id="tb-burger"><i class="fas fa-bars"></i></div>
      <div class="tb-profile" id="tb-profile"></div>
    </div>

  </div>

  <div class="tb-mobile-menu" id="tb-mobile-menu"></div>
</nav>

<!-- HERO -->
<section class="page-hero">
  <h1>Companion Profile</h1>
  <p>View and connect with your travel buddy</p>
</section>

<!-- CONTENT -->
<section class="page-content">

  <div class="profile-card">

    <img id="companionImg">
    <h2 id="companionName">Loading...</h2>
    <p id="companionEmail"></p>
    <p id="companionCollege"></p>
    <p id="companionBio"></p>
    <hr>

    <!-- TRAVEL STATS -->
    <div class="section">
      <h3>Travel Stats</h3>
      <div class="stats-grid">
        <div class="stat-card"><h4>Total Trips</h4><p id="trips">0</p></div>
        <div class="stat-card"><h4>Total Distance</h4><p id="distance">0 km</p></div>
        <div class="stat-card"><h4>Rating</h4><p id="rating">N/A</p></div>
      </div>
    </div>

    <!-- REQUEST SECTION -->
    <div id="requestSection">
      <button class="btn" id="requestBtn">Send Connect Request</button>
      <p class="small-muted" id="requestInfo"></p>
    </div>

    <!-- TRIPS -->
    <div class="section">
      <h3>Trips</h3>
      <div class="card" id="tripsList">No trips added.</div>
    </div>

  </div>
</section>

<script>
/* UNIVERSAL NAVBAR JS */
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user"));
  const defaultImg = "https://cdn-icons-png.flaticon.com/512/1077/1077114.png";

  const profileEl = document.getElementById("tb-profile");
  const mobileMenu = document.getElementById("tb-mobile-menu");
  const burger = document.getElementById("tb-burger");

  if(user){
    profileEl.innerHTML = `
      <img src="${user.img || defaultImg}">
      <i class="fas fa-caret-down"></i>
      <div class="tb-dropdown" id="tb-dropdown">
        <a href="profile.html">My Profile</a>
        <a href="trips.html">Trips</a>
        <a href="my-blogs.html">My Blogs</a>
        <a href="#" id="logout1">Logout</a>
      </div>
    `;

    mobileMenu.innerHTML = `
      <a href="index.html">Home</a>
      <a href="find-companion.html">Find Companion</a>
      <a href="explore.html">Plan a Trip</a>
      <a href="blog.html">Community</a>
      <a href="profile.html">My Profile</a>
      <a href="#" id="logout2">Logout</a>
    `;
  } else {
    profileEl.innerHTML = `<img src="${defaultImg}">`;
    mobileMenu.innerHTML = `
      <a href="index.html">Home</a>
      <a href="find-companion.html">Find Companion</a>
      <a href="explore.html">Plan a Trip</a>
      <a href="blog.html">Community</a>
    `;
  }

  document.addEventListener("click", (e)=>{
    if(e.target.closest("#tb-profile")){
      const dd=document.getElementById("tb-dropdown");
      dd.style.display = dd.style.display==="block" ? "none" : "block";
    } else {
      const dd=document.getElementById("tb-dropdown");
      if(dd) dd.style.display="none";
    }
  });

  const logout = () => {
    localStorage.removeItem("user");
    window.location.href="index.html";
  };

  document.getElementById("logout1")?.addEventListener("click", logout);
  document.getElementById("logout2")?.addEventListener("click", logout);

  burger.addEventListener("click", ()=>{
    mobileMenu.style.display = mobileMenu.style.display==="flex" ? "none" : "flex";
  });
});

/* COMPANION PROFILE LOGIC (unchanged) */
(async function(){
  const params = new URLSearchParams(window.location.search);
  let compEmail = params.get("email");

  const dataParam = params.get("data");
  if (!compEmail && dataParam) {
    try {
      compEmail = JSON.parse(decodeURIComponent(dataParam)).email;
    } catch(e){}
  }

  if (!compEmail) {
    alert("Invalid profile link");
    window.location.href = "find-companion.html";
  }

  const baseURL = window.location.hostname === "localhost"
    ? "http://localhost:5001"
    : "https://travelbuddy-hluu.onrender.com";

  const user = JSON.parse(localStorage.getItem("user"));
  const myEmail = user?.email;
  const defaultImg = "https://cdn-icons-png.flaticon.com/512/1077/1077114.png";

  const res = await fetch(`${baseURL}/api/user-profile?email=${compEmail}`);
  const out = await res.json();
  const u = out.user;

  document.getElementById("companionImg").src = u.img || defaultImg;
  document.getElementById("companionName").innerText = `${u.firstName} ${u.lastName}`;
  document.getElementById("companionEmail").innerText = u.email;
  document.getElementById("companionCollege").innerText = "College: " + (u.college || "N/A");
  document.getElementById("companionBio").innerText = u.bio || "";

  document.getElementById("trips").innerText = u.trips?.length || 0;
  document.getElementById("distance").innerText = (u.totalDistance || 0) + " km";
  document.getElementById("rating").innerText = u.rating || "N/A";

  const tl = document.getElementById("tripsList");
  if (u.trips?.length){
    tl.innerHTML = u.trips.map(t => `<p><b>${t.destination}</b> — ${t.date}</p>`).join("");
  } else {
    tl.innerHTML = "<p>No trips added.</p>";
  }

  const requestBtn = document.getElementById("requestBtn");
  const requestInfo = document.getElementById("requestInfo");

  if (!myEmail) {
    requestBtn.disabled = true;
    requestInfo.innerText = "Login to send requests.";
  }

  if (u.connections?.includes(myEmail)){
    requestBtn.style.display = "none";
    requestInfo.innerText = "You are already connected ✔";
  }

  const outgoing = user?.sentRequests || [];
  if (outgoing.some(r => r.toEmail === compEmail && r.status === "pending")) {
    requestBtn.disabled = true;
    requestInfo.innerText = "Request already sent — waiting for acceptance.";
  }

  requestBtn.onclick = async () => {
    requestBtn.disabled = true;

    const res = await fetch(`${baseURL}/api/send-request`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ fromEmail: myEmail, toEmail: compEmail })
    });

    const data = await res.json();
    if (data.success) {
      requestInfo.innerText = "Request sent! Waiting for acceptance.";
    } else {
      requestInfo.innerText = data.message || "Error.";
      requestBtn.disabled = false;
    }
  };

})();
</script>

</body>
</html>
